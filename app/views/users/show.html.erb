<br /><br />

<% @client = IEX::Api::Client.new(
    publishable_token: 'pk_3fac9a23e6694fdcb684099ec25cf67b',
    secret_token: 'sk_9d27a9ab69c64168ad4fad54cf700ecb',
    endpoint: 'https://cloud.iexapis.com/v1'
)%>

<section class="section">
    <div class="columns is-centered">
        <div class="column is-narrow">
            <h3 class="title"><%= @user.email %></h3>
            <span class="subtitle">
                Role:     
                <% if @user.role_id === 1 %>
                    Admin
                <% elsif @user.role_id === 2 %>
                    Broker
                <% else %>
                    Buyer
                <% end %>
            </span>
            <br/>
            <table class="table">
                <thead>
                    <th>Symbol</th>
                    <th>Company</th>
                    <th>Latest Price</th>
                    <th>Qty</th>
                    <% if user_signed_in? && current_user.role_id === 2 && current_user.status_approved? && current_user == @user %>
                        <th>broker options</th>
                    <% end %>
                    <% if user_signed_in? && current_user.role_id === 3 && current_user == @user %>
                        <th>buyer options</th>
                    <% end %>
                </thead>
                <tbody>
                    <% if @user.role_id === 2 %>
                        <h1 class="title">Stocks for Sale</h1>
                    <% elsif @user.role_id === 3 %>
                    <h1 class="title">Stocks Acquired</h1>
                    <% end %>
                    
                    <% @user_stocks = UserStock.where(user_id: @user.id) %>

                    <%# @stocks.each do |stock| %>
                    <% @user_stocks.each do |user_stock| %>
                        <% stock = Stock.find_by(id: user_stock.stock_id) %>
                        <tr>
                            <% quote = @client.quote(stock.symbol) %>
                            <td> <%= "#{stock.symbol}" %> </td>
                            <td> <%= "#{quote.company_name}" %> </td>
                            <td> <%= "#{quote.latest_price}" %> </td>
                            <td> <%= "#{user_stock.quantity}" %> </td>
                            
                            <%# conditions for broker POV%>
                            <% if user_signed_in? && current_user.role_id == 2 && current_user.status_approved? && current_user === @user %>
                                <td>
                                    <%= link_to "remove", user_stock_path(:id => user_stock.id, :user_id => @user.id), method: :delete, data: { confirm: 'Are you sure?' } %>
                                </td>
                            <% end %>

                            <%# conditions for buyer POV%>
                            <% if user_signed_in? && current_user.role_id == 3 && current_user === @user %>
                                <td>
                                    <%= link_to "remove", user_stock_path(:id => user_stock.id, :user_id => @user.id), method: :delete, data: { confirm: 'Are you sure?' } %>
                                </td>
                            <% end %>

                        </tr>
                    <% end %>
                </tbody>
            <table>
        </div>
    </div>
</section>


